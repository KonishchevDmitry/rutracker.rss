#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""Suggests torrents to ignore."""

import logging

import pycl.main
from pycl.cli.text_table import TextTable

from rutracker.db import coll


def main():
    """The script's main function."""

    pycl.main.set_environment()

    torrents = coll("torrents").group(
        [ "fingerprint" ], {}, { "count": 0 }, """
        function(obj, aggregated) {
            aggregated.name = obj.name;
            aggregated.count++;
        }"""
    )
    torrents.sort(key = lambda a: a["count"], reverse = True)
    torrents = torrents[:10]

    if torrents:
        print "Please consider to exclude the following torrent groups:"
        table = TextTable()
        for torrent in torrents:
            table.add_row({
                "count": torrent["count"],
                "group": torrent["fingerprint"],
                "name":  torrent["name"],
            })
        table.draw([
            { "id": "count",  "name": "Count", "align": "right" },
            { "id": "group",  "name": "Group", "align": "left"  },
            { "id": "name",   "name": "Name",  "align": "left", "max_width": 100 },
        ])
        #    print u"{0}".format()
        #    print json.dumps(i, ensure_ascii = False)
    else:
        print "There is nothing to suggest."


if __name__ == "__main__":
    main()
